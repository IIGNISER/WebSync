<%
user ||= current_user

sort = "recent"
sort_modes = %w(owner name recent, size)
invert = false
request.params.each do |k, v|
    if sort_modes.include? k
        sort = k
    elsif k == "invert"
        invert = true
    end
end
options ||= {}
options[:parent] = nil
order = :edit_time
order = :name if sort == "name"
sort_up = !invert
sort_up = invert if sort=="recent"
options[:order] = [sort_up ? order.asc : order.desc]
options[:deleted] ||= false
docs = WSFile.all({visibility: "public"}.merge(options)) if defined?(shared) and shared
docs ||= user.files options

docs = docs.sort do |a,b|
    if invert
        a.size <=> b.size
    else
        b.size <=> a.size
    end
end if sort=="size"

docs = docs.sort do |a,b|
    owner_a = a.owner
    owner_b = b.owner
    # Always put the orphaned document at the bottom.
    if owner_a.nil? or owner_b.nil?
        if owner_a.nil?
            1<=>0
        else
            0<=>1
        end
    elsif invert
        owner_a.email <=> owner_b.email
    else
        owner_b.email <=> owner_a.email
    end
end if sort == "owner"


headers = %w{name owner recent size}

def path p
  request.path == p ? 'class="active"' : ''
end

%>
<div class="file_list">
  <div class="menu">
    <ul class="nav nav-pills nav-stacked">
      <%= erb :upload_buttons %>
      <li role="presentation" <%= path '/' %> ><a href="/"><%= t "files.mine" %></a></li>
      <li role="presentation" <%= path '/public' %> ><a href="/public"><%= t "files.public" %></a></li>
      <li role="presentation" <%= path '/deleted' %> ><a href="/deleted"><%= t "recover" %></a></li>
    </ul>
  </div>
  <div class="files">
    <div class="search">
      <div class="input-group">
        <input type="text" class="form-control" placeholder="<%= t('search.search') %>">
        <span class="input-group-btn">
          <button class="btn btn-primary" type="button"><%= t('search.search') %></button>
        </span>
      </div><!-- /input-group -->
    </div>
    <table class="table table-hover table-click"></table>
  </div>
  <%= javascript_tag 'file_browser.js' %>
</div>
